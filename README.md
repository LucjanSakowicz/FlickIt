# FlickIt – Architecture & Documentation Outline

## 1. Purpose & Vision

Short‑lived, location‑based deals that create FOMO and move users to local businesses.

## 2. High‑Level Architecture

* **Mobile App (Android, Kotlin + Jetpack Compose)**
* **Backend (Java 17 + Spring Boot)** – modular monolith
* **Shared Library** – DTO & contract model (Java/Kotlin)
* **External Services**: OpenAI Vision + GPT, Firebase Cloud Messaging, Google Maps Platform, PostgreSQL

## 3. Backend Modules (Spring Boot)

| Module         | Responsibility                                |
| -------------- | --------------------------------------------- |
| `event`        | CRUD + lifecycle of deals/events              |
| `user`         | Registration, auth, roles (vendor / customer) |
| `notification` | Push scheduling & FCM integration             |
| `ai`           | Gateway to OpenAI (image → text)              |
| `config`       | Security, CORS, profiles, OpenAPI docs        |

## 4. Mobile App Layers

* **UI** – Compose screens: Map, AddOffer, Profile
* **Domain** – Use‑cases / ViewModels (Hilt DI)
* **Data** – Retrofit/Ktor client → REST API, Room cache

## 5. Shared DTOs (with field descriptions)

### VisionLabelDto

| Field        | Type         | Description                                                         |
| ------------ | ------------ | ------------------------------------------------------------------- |
| `label`      | String       | Human‑readable tag detected by OpenAI Vision (e.g., "cake", "shoe") |
| `confidence` | Double (0–1) | Probability that the label is correct                               |

### EventDto

| Field                | Type                           | Description                                                 |   |      |                    |
| -------------------- | ------------------------------ | ----------------------------------------------------------- | - | ---- | ------------------ |
| `id`                 | UUID                           | Unique identifier of the event                              |   |      |                    |
| `titleAi`            | String                         | Title generated by GPT from the selected AI image           |   |      |                    |
| `titleVendor?`       | String                         | Title manually provided by vendor (optional)                |   |      |                    |
| `descriptionAi`      | String                         | AI‑generated description                                    |   |      |                    |
| `descriptionVendor?` | String                         | Vendor‑written description (optional)                       |   |      |                    |
| `lat` / `lon`        | Double                         | GPS coordinates (WGS‑84) of the event location              |   |      |                    |
| `alt`                | Double?                        | Altitude in meters (nullable)                               |   |      |                    |
| `floor?`             | Int?                           | Floor level inside multistory buildings (nullable)          |   |      |                    |
| `images`             | List<String>                   | HTTPS URLs of all images for the event                      |   |      |                    |
| `aiImageUrl?`        | String?                        | URL of the image that was passed to GPT for generating text |   |      |                    |
| `visionLabels?`      | List<VisionLabelDto>           | Tags + confidences produced for `aiImageUrl`                |   |      |                    |
| `category`           | Enum("FOOD","SERVICE","OTHER") | Category for compliance and analytics                       |   |      |                    |
| `expiresAt`          | Instant                        | Absolute time when the offer disappears                     |   |      |                    |
| `vendorId`           | UUID                           | Owner of the event                                          |   | UUID | Owner of the event |

### UserDto

| Field          | Type                              | Description                               |
| -------------- | --------------------------------- | ----------------------------------------- |
| `id`           | UUID                              | User identifier                           |
| `name`         | String                            | Display name or business name             |
| `phone`        | String                            | Verified phone number (E.164)             |
| `role`         | Enum("VENDOR","CUSTOMER","ADMIN") | Access level                              |
| `rating?`      | Double?                           | Time‑weighted average rating (1–5)        |
| `ratingCount?` | Int?                              | Number of ratings contributing to average |

### CreateEventRequest

| Field             | Type                                  | Description                                               |
| ----------------- | ------------------------------------- | --------------------------------------------------------- |
| `imagesBase64`    | List<String>                          | Up to **3** base64‑encoded images                         |
| `aiImageUrl`      | String                                | Which of the uploaded images should feed GPT              |
| `discount`        | String                                | Human string like "‑10%" or "2 for 1"                     |
| `style`           | Enum("FUN","PROFESSIONAL","ENGAGING") | Tone for GPT                                              |
| `expiresAt`       | Instant                               | Offer expiry timestamp (event visibility)                 |
| `category`        | Enum("FOOD","SERVICE","OTHER")        | Required for compliance checks                            |
| `expiryDate?`     | LocalDate                             | Applicable when category requires shelf‑life (e.g., FOOD) |
| `productCategory` | Enum("FOOD","SERVICE","OTHER")        | Required for compliance checks                            |
| `foodExpiryType?` | Enum("USE\_BY","BEST\_BEFORE")        | Mandatory if `productCategory=FOOD`                       |
| `foodExpiryDate?` | LocalDate                             | Date printed on package; enforced if above fields present |

### ClaimEventRequest

| Field     | Type | Description         |
| --------- | ---- | ------------------- |
| `eventId` | UUID | Event being claimed |
| `userId`  | UUID | Claiming customer   |

### RateEventRequest

| Field      | Type      | Description                                        |
| ---------- | --------- | -------------------------------------------------- |
| `eventId`  | UUID      | Event being rated                                  |
| `rating`   | Int (1–5) | Star rating                                        |
| `comment?` | String?   | Optional free‑text feedback                        |
| `ratedAt?` | Instant?  | Client timestamp of rating (fallback: server time) |

## 6. Core Domain Entities (with field descriptions)

### Event

| Field                                  | Type                                         | Note                 |
| -------------------------------------- | -------------------------------------------- | -------------------- |
| `id`                                   | UUID                                         | PK                   |
| `status`                               | Enum("ACTIVE","CLAIMED","EXPIRED","REMOVED") | Lifecycle stage      |
| `titleAi` / `titleVendor?`             | String                                       | Stored titles        |
| `descriptionAi` / `descriptionVendor?` | String                                       | Stored descriptions  |
| `lat` / `lon` / `alt` / `floor?`       | Double / Int                                 | Location + elevation |
| `expiresAt`                            | Instant                                      | TTL of event         |

### EventImage

| Field         | Type       | Note                     |
| ------------- | ---------- | ------------------------ |
| `id`          | UUID       | PK                       |
| `eventId`     | FK → Event | Owner event              |
| `url`         | String     | CDN/S3 URL               |
| `idx`         | Int        | Order provided by vendor |
| `isAiSource?` | Boolean    | `true` if used by GPT    |

### EventVisionLabel

| Field          | Type            | Note            |
| -------------- | --------------- | --------------- |
| `eventImageId` | FK → EventImage | Which image     |
| `label`        | String          | Tag name        |
| `confidence`   | Double          | Probability 0–1 |

### EventCompliance

| Field         | Type                           | Note                          |
| ------------- | ------------------------------ | ----------------------------- |
| `eventId`     | FK → Event                     | Owner event                   |
| `category`    | Enum("FOOD","SERVICE","OTHER") | Category for compliance       |
| `expiryDate?` | LocalDate                      | Shelf‑life date if applicable |

### User

| Field          | Type      | Note                    |
| -------------- | --------- | ----------------------- |
| `id`           | UUID      | PK                      |
| `phone`        | String    | E.164                   |
| `roles`        | Set<Role> | Multiple roles possible |
| `ratingAvg?`   | Double    | Cached weighted average |
| `ratingCount?` | Int       | Cached count            |

### Claim

| Field                | Type     | Note                  |
| -------------------- | -------- | --------------------- |
| `eventId` / `userId` | FK       | Composite PK          |
| `createdAt`          | Instant  | Claim timestamp       |
| `rating?`            | Int?     | Stars 1–5             |
| `comment?`           | String?  | Feedback              |
| `ratedAt?`           | Instant? | When rating submitted |

### NotificationSubscription

| Field                     | Type      | Note                    |
| ------------------------- | --------- | ----------------------- |
| `token`                   | String    | FCM device token        |
| `userId`                  | FK → User | Owner                   |
| `radius`                  | Double    | Subscription radius (m) |
| Core Domain Entities (DB) |           |                         |

* `Event` (PK id, status, titleAi, titleVendor?, descriptionAi, descriptionVendor?, category, expiryDate?, GeoPoint, alt, floor?, expiresAt, …)
* `User` (PK id, phone, roles…, ratingAvg?, ratingCount?)
* `NotificationSubscription` (token, userId, radius)
* `EventImage` (PK id, eventId FK, url, idx, isAiSource?)
* `EventVisionLabel` (eventImageId FK, label, confidence)
* `Claim` (eventId, userId, createdAt, rating?, comment?, ratedAt?)

## 7. Data Flow – MVP

1. **Create Deal**

   * Vendor → Mobile → POST `/events` (CreateEventRequest)
   * Backend → AI → DB save → push to `/topic/area/{geoHash}`
2. **Receive Deal**

   * Customer device subscribed via FCM topic → notification → opens Map → GET `/events/latest?geo=…`
3. **Claim Deal**

   * Customer → PUT `/events/{id}/claim` → optional phone call step
4. **Geo‑verified Rating** *(anti hate‑bomb)*

   * Mobile registers **geofence** (radius *n* m) around event location at claim time
   * Android OS triggers `ENTER` → app shows rating UI; rating allowed only inside fence ± *n* m
   * Upon rating POST `/rate` (RateEventRequest) → Claim.rating/comment stored## 8. MVP Feature List

* Vendor login (SMS code) & create event (up to 3 images (configurable via admin API), choose aiImageUrl, discount, style, expiry, manual floor/altitude selection)
* AI autogeneration of title/description
* Push notification to users in 2 km radius
* Map with live markers; navigation opens Google Maps via Intent (external app). UI wyświetla "Floor X" lub "±m" na podstawie alt/floor przekazanych przez sprzedawcę.
* Manual claim flow (no online payment yet)
* After claim, buyer can POST `RateEventRequest`; data stored in Claim.rating/comment
* **Manual completion & rating**: sprzedawca ręcznie zdejmuje event z listy, kupujący ocenia ofertę (1–5 ⭐️) w aplikacji

## 9. Non‑Functional

* Gradle KTS, Docker Compose for DB + pgAdmin
* CI: GitHub Actions (test, build, container image)
* OpenAPI 3 docs via springdoc‑openapi

## 10. Future Extensions *(parking lot)*

* In‑app payments
* Loyalty / points system
* Multi‑city sharding, microservices split
* Vendor analytics dashboard
* Automatic arrival detection & push confirmation + instant rating (Smart Arrival)
* **CI/CD Pipeline Enhancements**
  * Postman e2e test automation jobs for comprehensive API testing
  * JMeter performance testing jobs for load and stress testing
  * CRaC (Coordinated Restore at Checkpoint) integration for faster component scaling and reduced cold start times
  * SonarQube integration for code quality analysis and technical debt monitoring
  * Pitest mutation testing for comprehensive test coverage validation
  * Elastic APM integration for application performance monitoring and distributed tracing

---

## 11. Threats & Mitigations

| Risk                              | Issue                                                                                                                                                           | MVP Patch                                                                                                             | Long‑term Fix                                                                                   |
| --------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| **Fake or scam deals**            | Non‑existent offer wastes buyers' time                                                                                                                          | SMS one‑tap vendor verify; 30 min cooldown                                                                            | KRS/NIP check, vendor deposit, reputation weighting                                             |
| **Trademark misuse**              | Photo shows protected logo/brand without rightful context (e.g., item not genuine or misuse of brand assets). Legitimate resale with nominative use is allowed. | OpenAI Vision moderation flag "trademark" + user report button                                                        | Notice‑and‑takedown workflow, vendor T\&C clause, hash‑match (e.g., PhotoDNA)                   |
| **Inappropriate content**         | Nudity, minors, extremist symbols                                                                                                                               | Same moderation flow as above                                                                                         | Dedicated moderation team + ML ensemble                                                         |
| **Expired food regulations**      | In EU/PL, selling after *„use‑by”* date is illegal; platform facilitating may share liability                                                                   | Force vendor to mark *best‑before* vs *use‑by*; warning banner to buyer                                               | Category filter blocks "use‑by" past date; periodic purge jobs                                  |
| **No‑show buyers**                | Vendor blocks product, buyer never comes                                                                                                                        | Manual no‑show mark affects buyer rating                                                                              | Token deposit, auto ban ratio                                                                   |
| **Push flood**                    | Too many offers in dense area                                                                                                                                   | Client‑side 3/h limit                                                                                                 | ML notification throttling                                                                      |
| **Location privacy**              | Precise GPS stored                                                                                                                                              | Hash + 30 d retention                                                                                                 | Differential privacy / edge‑processing                                                          |
| **Battery drain**                 | Continuous GPS                                                                                                                                                  | Geofence 350 m, wake 10 min                                                                                           | Adaptive updates                                                                                |
| **Altitude jitter**               | Indoor GPS ±30 m                                                                                                                                                | Manual floor select                                                                                                   | BLE beacons / Indoor Maps SDK                                                                   |
| **Alcohol/tobacco compliance**    | Age‑restricted goods                                                                                                                                            | Block category in MVP                                                                                                 | ID verification later                                                                           |
| **SIM‑swap account takeover**     | SMS‑only login vulnerable                                                                                                                                       | Email backup & change‑number cooldown                                                                                 | TOTP/push 2FA, alert on number change                                                           |
| **OpenAI cost spike**             | Unlimited image uploads burn budget                                                                                                                             | Hard limit X uploads/day, alerting                                                                                    | Batch processing, fallback local model                                                          |
| **AI hallucination**              | Generated description inaccurate                                                                                                                                | Vendor must approve AI text                                                                                           | Fact‑scoring, higher‑quality models                                                             |
| **App Store push policy**         | Push used as broad ads                                                                                                                                          | Limit to geo‑subscribers only                                                                                         | Opt‑in categories, segmentation                                                                 |
| **Traffic spike / DB load**       | Viral event crashes backend                                                                                                                                     | Simple autoscale compose                                                                                              | k8s, read‑replica, Redis cache                                                                  |
| **Accessibility gaps**            | Map unusable for visually impaired                                                                                                                              | Basic alt‑text, keyboard nav                                                                                          | Full ARIA/TalkBack support                                                                      |
| **Phishing links in description** | Malicious URLs trick users                                                                                                                                      | Block links via regex                                                                                                 | URL reputation scanner                                                                          |
| **GPS log retention >30d**        | GDPR violation                                                                                                                                                  | Auto‑purge 30d                                                                                                        | DPIA, EU‑only storage                                                                           |
| **Vendor impersonation**          | Fake business profile                                                                                                                                           | KRS/NIP check on onboarding                                                                                           | e‑signature/Profil Zaufany                                                                      |
| **Illegal digital goods**         | Piracy/IPTV offers                                                                                                                                              | Block list category + AI detect                                                                                       | Trust & Safety review pipeline                                                                  |
| **Review bombing (hate‑bomb)**    | Coordinated 1‑star attacks to tank ratings                                                                                                                      | Time‑weighted average, one rating per deal/user; require rating submission within geo‑fence (± n m) of event location | AI anomaly detection, rating‑spam cooldown, geo‑verified rating radius, manual moderator review |
| **Dishonest vendor reports**      | Buyer suspects fraud or repeated rule‑breaking                                                                                                                  | In‑app “Report vendor” button → creates Trust & Safety ticket                                                         | Escalation workflow, strike system leading to suspension                                        |

---

## 12. Quick Start Guide

### Prerequisites
- Java 17+
- Maven 3.6+
- Docker & Docker Compose
- PostgreSQL (optional, H2 used for tests)

### Local Development

1. **Clone and setup**
   ```bash
   git clone <repository-url>
   cd FlickIt-v0.0
   ```

2. **Run tests**
   ```bash
   mvn test
   # or use Makefile
   make test
   ```

3. **Run locally**
   ```bash
   mvn spring-boot:run
   # or use Makefile
   make run
   ```

4. **Access endpoints**
   - API: http://localhost:8080
   - Swagger UI: http://localhost:8080/swagger-ui.html
   - H2 Console (test): http://localhost:8080/h2-console

### Docker Setup

1. **Start services**
   ```bash
   docker-compose up -d
   # or use Makefile
   make docker-run
   ```

2. **Access services**
   - Backend: http://localhost:8080
   - PostgreSQL: localhost:5432
   - pgAdmin: http://localhost:5050 (admin@local / admin)

3. **Stop services**
   ```bash
   docker-compose down
   # or use Makefile
   make docker-stop
   ```

### Environment Variables

Copy `env.example` to `.env` and configure:
```bash
cp env.example .env
# Edit .env with your values
```

### Available Commands

```bash
make help          # Show all available commands
make build         # Build application
make test          # Run tests
make docker-build  # Build Docker image
make status        # Show system status
```

### CI/CD

The project includes GitHub Actions workflow (`.github/workflows/ci-cd.yml`) that:
- Runs tests on every push/PR
- Builds Docker image on main branch
- Performs security scanning
- Pushes to GitHub Container Registry

---

> **Note:** Vendor remains primarily responsible for product authenticity & compliance (e.g., food safety, trademark). FlickIt enforces policy checks and acts on reports (safe‑harbor).
